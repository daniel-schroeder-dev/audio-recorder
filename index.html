<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8" />
        <title>Audio Recorder</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 8px;
                width: fit-content;
                padding: 24px 64px;
                height: 70vh;
                margin: 24px auto 0px auto;
                box-shadow: 0px -1px 7px 2px rgb(100 100 100 / 75%);
                border: 1px solid #f2f2f2;
            }

            #top-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 65%;
            }

            p {
                align-self: flex-start;
                text-align: justify;
                max-width: 500px;
                margin: 4px;
                line-height: 1.4;
            }

            h1 {
                margin-top: 0px;
            }

            h2 {
                margin: 0;
            }

            ul {
                list-style-type: none;
                padding: 0;
            }

            li {
                border: 1px solid #a7a7a7;
                margin: 8px;
                border-radius: 3px;
                width: fit-content;
                padding: 7px;
                cursor: pointer;
            }

            li:hover {
                background-color: #bcbcbc;
            }

            section {
                width: fit-content;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            main {
                height: 35%;
                display: flex;
                flex-direction: column;
                align-content: center;
                position: relative;
                flex-grow: 1;
            }

            button {
                padding: 10px;
                border-radius: 6px;
            }

            #button-group {
                margin: 24px 0;
            }

            #button-group button:first-child {
                margin-right: 12px;
            }

            #record-message {
                visibility: hidden;
                align-self: center;
            }

            /* Taken from: https://loading.io/css/ */

            .lds-dual-ring {
                display: inline-block;
                width: 80px;
                height: 80px;
                position: absolute;
                left: calc(50% - 40px);
            }

            .lds-dual-ring:after {
                content: " ";
                display: block;
                width: 64px;
                height: 64px;
                margin: 8px;
                border-radius: 50%;
                border: 6px solid #7395ff;
                border-color: #7395ff transparent #7395ff transparent;
                animation: lds-dual-ring 1.2s linear infinite;
            }

            @keyframes lds-dual-ring {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div id="top-container">
            <h1>CWHQ Audio Recorder</h1>

            <p>
                Select your preferred audio device and then press the "Record" button to record an
                audio file. Press "Stop" and you'll be prompted to save your recording. If you want
                to make another recording, repeat the process!
            </p>

            <div id="button-group">
                <button id="record" disabled>Record</button>
                <button id="stop" disabled>Stop</button>
            </div>

            <p id="record-message">Press 'Record' to begin recording!</p>
        </div>

        <main><div id="loader-icon" class="lds-dual-ring"></div></main>

        <script>
            // See: https://web.dev/media-recording-audio/
            const recordButton = document.querySelector("#record");
            const stopButton = document.querySelector("#stop");
            const mainElement = document.querySelector("main");
            const recordMessage = document.querySelector("#record-message");

            navigator.mediaDevices.getUserMedia({ audio: true }).then(() => {
                navigator.mediaDevices.enumerateDevices().then(pickAudioDevice).catch(console.error);
            });



            function pickAudioDevice(devices) {
                const inputDevices = devices.filter(
                    (device) => device.kind === "audioinput" && device.label !== "Default"
                );
                displayInputDevices(inputDevices);
            }

            function displayInputDevices(inputDevices) {
                mainElement.innerHTML = "";
                const section = document.createElement("section");
                const h2 = document.createElement("h2");
                const ul = document.createElement("ul");

                h2.textContent = "Please choose your input device:";

                for (const inputDevice of inputDevices) {
                    const li = document.createElement("li");
                    li.textContent = inputDevice.label;
                    li.dataset.deviceId = inputDevice.deviceId;
                    ul.append(li);
                }

                ul.addEventListener("click", chooseInputDevice);

                section.append(h2);
                section.append(ul);

                mainElement.append(section);
            }

            function chooseInputDevice(event) {
                recordMessage.style.visibility = "visible";
                document.querySelector("section").style.visibility = "hidden";
                const constraints = {
                    audio: {
                        deviceId: event.target.dataset.deviceId,
                    },
                };
                navigator.mediaDevices.getUserMedia(constraints).then(registerMediaListeners);
                recordButton.disabled = false;
            }

            function registerMediaListeners(stream) {
                const options = { mimeType: "audio/webm" };
                let recordedChunks = [];
                const mediaRecorder = new MediaRecorder(stream, options);

                mediaRecorder.addEventListener("dataavailable", (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                });

                mediaRecorder.addEventListener("stop", (e) => {
                    const downloadLink = document.createElement("a");
                    const url = URL.createObjectURL(
                        new Blob(recordedChunks, { type: recordedChunks[0].type })
                    );
                    downloadLink.href = url;
                    downloadLink.download = "voice-recording.webm";
                    downloadLink.style.display = "none";
                    mainElement.append(downloadLink);
                    downloadLink.click();
                    window.URL.revokeObjectURL(url);
                });

                stopButton.addEventListener("click", (e) => {
                    recordMessage.style.visibility = "visible";
                    mediaRecorder.stop();
                    stopButton.disabled = true;
                    recordButton.disabled = false;
                    recordedChunks = [];
                });

                recordButton.addEventListener("click", (e) => {
                    recordMessage.style.visibility = "hidden";
                    mediaRecorder.start();
                    stopButton.disabled = false;
                    recordButton.disabled = true;
                });
            }
        </script>
    </body>
</html>
